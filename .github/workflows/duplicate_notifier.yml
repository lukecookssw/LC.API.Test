on:
  issues:
    types: [closed]

jobs:
  find-duplicate-target:
    runs-on: ubuntu-latest

    steps:
      - name: Find linked issue if closed as duplicate
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload;
            const owner = payload.repository.owner.login;
            const repo = payload.repository.name;
            const issue_number = payload.issue.number;

            const author = payload.issue.user.login;
            const stateReason = payload.issue.state_reason;

            if (payload.issue.state_reason !== 'duplicate') {
              core.info(`Issue #${issue_number} was closed, but not as a duplicate.`);
              return;
            }

            // Fetch recent comments on the issue
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 10,
            });

            // Look for "#123" pattern in comment bodies
            const regex = /#(\d+)/g;
            let match = null;
            let targetIssueNumber = null;
            for (const comment of comments.data.reverse()) {
              match = regex.exec(comment.body);
              if (match) {
                core.info(`Found linked issue #${match[1]} from comment: "${comment.body}"`);
                core.setOutput('duplicate_of', match[1]);
                targetIssueNumber = match[1];
                break;
              }
            }

            if (!targetIssueNumber) {
              core.warning(`No linked issue number found in comments for issue #${issue_number}.`);
              return;
            }

            // Build the comment message
            const message = `ðŸ‘‹ @${author} closed issue #${issue_number} as a duplicate of this one. We've @ mentioned you here so you can keep track of activity :smile:`;

            // Post comment on the *target* issue
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: targetIssueNumber,
              body: message,
            });

            core.info(`ðŸ’¬ Comment posted on issue #${targetIssueNumber}: "${message}"`);

