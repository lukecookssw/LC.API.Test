on:
  issues:
    types: [closed]

jobs:
  find-duplicate-target:
    runs-on: ubuntu-latest

    steps:
      - name: Find linked issue if closed as duplicate
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload;
            const owner = payload.repository.owner.login;
            const repo = payload.repository.name;
            const issue_number = payload.issue.number;

            if (payload.issue.state_reason !== 'duplicate') {
              core.info(`Issue #${issue_number} was closed, but not as a duplicate.`);
              return;
            }

            // Fetch recent comments on the issue
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number,
              per_page: 10,
            });

            // Look for "#123" pattern in comment bodies
            const regex = /#(\d+)/g;
            let match = null;
            for (const comment of comments.data.reverse()) {
              match = regex.exec(comment.body);
              if (!match) {
              core.warning(`No linked issue number found in comments for issue #${issue_number}.`);
                return;
              }
            }
            core.info(`Found linked issue #${match[1]} from comment: "${comment.body}"`);
            const targetIssueNumber = match[1];

            // Build the comment message
            const message = `ðŸ‘‹ @${author}, we've closed your issue #${issue_number} as a duplicate of this one. We've @ mentioned you here so you can keep track of updates. Thanks!`;

            // Post comment on the *target* issue
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: targetIssueNumber,
              body: message,
            });

            core.info(`ðŸ’¬ Comment posted on issue #${targetIssueNumber}: "${message}"`);
